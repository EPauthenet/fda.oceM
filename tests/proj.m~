function pc = proj(fdobj,pca)
% Projection of multivariate hydrographic profiles on a basis of
% decomposition
%
% proj This function projects multivariate hydrographic profiles on a basis
% defined with the function fpca. It returns the Principal Components (PCs)
% of the profiles.
%
% Arguments:
% FDOBJ ... functional object containing the coefficients of the spline in an array
% in that order nbas * nobs * nvar
% PCA ... structure containing the 
% Return
% PCA ... structure containing the eigenvectors, eigenvalues,...
%
% DEPANDANCIES
% The method uses the fdaM Toolbox by Jim Ramsay.
% http://www.psych.mcgill.ca/misc/fda/downloads/FDAfuns/Matlab/
% You will need to install this toolbox and add it to the matlab path to use this software
%
% CONTACT
% This code was written by Etienne Pauthenet, David Nerini and Fabien Roquet. 
% Questions, comments and bugs can be sent to: 
% etienne.pauthenet@gmail.com
% 
% REFERENCES 
% Pauthenet et al. (2017) A linear decomposition of the Southern Ocean thermohaline structure. Journal of Physical Oceanography, http://dx.doi.org/10.1175/JPO-D-16-0083.1
% Ramsay, J. O., and B. W. Silverman, 2005: Functional Data Analysis. 2nd Edition Springer, 426 pp., Isbn : 038740080X.
%
% See also function proj for computing the principal components (PCs) of a dataset.

% Projection of Temperature and Salinity profiles
%
% Projection of any Temperature and Salinity (T-S) profiles on a chosen basis. It is essential to locate a profile relatively to a climatology. The profiles to project must have the same \code{myb} than the modes to project on (i.e. same length of profile \code{c(dmin,dmax)} and same number of Bsplines \code{mybn}).
%
% @param temp.fd,sal.fd fd objects (list) of the T-S profile(s) to project. This is produced by the function \code{bspl}.
% @param pca list of the modes to project on, produced by the function \code{fpca}.
% @param te how many PCs to use in the reconstruction, default is set to the total number of PC, \code{te = mybn}.
% @return \code{Npc} The principal components of the profiles \code{temp.fd} and \code{sal.fd} projected on the modes contained in \code{pca}.
%
% Authors : 
% Etienne Pauthenet \email{<etienne.pauthenet@gmail.com>}, David Nerini \code{<david.nerini@univ-amu.fr>}, Fabien Roquet \code{<fabien.roquet@gu.se>}
% References : 
% Pauthenet et al. (2017) A linear decomposition of the Southern Ocean thermohaline structure. Journal of Physical Oceanography, http://dx.doi.org/10.1175/JPO-D-16-0083.1
% Ramsay J. O., and B. W. Silverman, 2005: Functional Data Analysis. Springer, 426 pp.
%
% @seealso \code{\link{bspl}} for bsplines fit on T-S profiles, \code{\link{fpca}} FPCA of T-S profiles, \code{\link{PCmap}} for plotting a map of PC, \code{\link{kde_pc}} for kernel density estimation of two PCs...

basis = pca.basis;
nbas = getnbasis(basis);
ndim = pca.ndim;
Cm = pca.Cm;
coef  = getcoef(fdobj);
nobs = size(coef,2);

C = zeros(nobs,ndim*nbas);
for kk=1:ndim,
    C(:,(kk-1)*nbas+1:kk*nbas) = squeeze(coef(:,:,kk))';
end
Cc = C - repmat(Cm,nobs,1);

pc = Cc * pca.W' * pca.M * pca.vectors;

